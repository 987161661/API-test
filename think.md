# 开发备忘录 (Think Log)

## 📅 更新日期: 2025-12-26

## 🛠️ 本次迭代核心改动

### 1. 稳定性与协议修复
- **OpenAI 兼容性增强** (`providers/openai_compatible.py`):
  - **自动补全协议**: 针对 `base_url` 缺失 `http://` 或 `https://` 的情况，增加了自动检测和补全逻辑（本地地址默认为 `http`，其他为 `https`）。
  - **Header 清洗**: 修复了 API Key 中包含换行符或空格导致 `httpx` 抛出 `Illegal header value b'Bearer '` 的问题，在初始化时强制 `strip()`。

### 2. 配置管理机制重构
- **消除“幽灵成员”** (`chat_server.py`):
  - 修改了 WebSocket `setup` 消息的处理逻辑。
  - **机制变更**: 从“增量更新”改为“全量重建”。每次前端发起 `setup`（开始模拟）时，后端会根据当前前端传递的 `models` 列表重建 `member_configs`。
  - **效果**: 彻底解决了从列表中移除模型后，重启模拟时旧模型（如 Gemini）依然残留在配置文件和群聊中的问题。同时保留了头像等用户自定义数据。

### 3. 指令系统鲁棒性提升
- **JSON 指令防泄露** (`core/consciousness.py`):
  - **双重保障**:
    1. **Prompt 强化**: 系统提示词中明确禁止输出 Markdown 代码块和解释性文字，要求仅输出纯 JSON。
    2. **正则兜底**: 在代码层引入正则表达式提取机制。即使模型输出了混合文本（如 `好的，执行引用：{"type": "quote"...}`），也能精准提取出 JSON 指令并执行，防止原始指令文本直接显示在聊天框中。

### 4. UI 同步修复
- **侧边栏实时更新** (`components/websocket_chat.py`):
  - 修复了侧边栏群组名称在修改后未实时同步的问题，增加了对应的 DOM 操作逻辑。

## 🧭 后续开发规划与建议

### 短期优化
- **异常处理**: 目前对于 JSON 解析失败仅做了 `pass` 处理，建议增加更详细的 debug 日志（仅在开发模式下显示），以便排查模型指令格式问题。
- **头像缓存**: 目前头像数据依赖前端传递或保留在 config 中，考虑建立专门的头像资源管理机制。

### 长期方向
- **多群组支持**: 当前架构支持 `room_id`，但前端 UI 主要针对单房间优化。未来可扩展为多房间大厅模式。
- **剧本编辑器**: `scenario_config` 目前依赖手动编辑 JSON，未来可开发可视化的剧本编排工具。

## 📝 注意事项
- 修改 `chat_server.py` 或 `core/consciousness.py` 后，务必确保 `uvicorn` 服务重启（当前已开启 `--reload`，但在某些严重语法错误下可能需要手动干预）。
- `chat_config_consciousness_lab.json` 现在是动态生成的，手动修改该文件可能在下一次模拟开始时被覆盖，请通过前端界面或 `setup` 协议进行配置管理。

---
*此文件旨在为后续开发提供上下文无缝衔接。*
